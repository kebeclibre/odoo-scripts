#!/usr/bin/env python3
import argparse
import os
import sys
from pathlib import Path
import subprocess
import re

home = Path.home()

odooRepos = {
  "odoo": "devel/distr0/odoo",
  "enterprise": "devel/distr0/enterprise"
}

worktrees_root = "devel/worktrees"
worktreepath = worktrees_root + "/{version}"
odoo_bin_path = "odoo/odoo-bin"

branch_re = re.compile("(saas-)?(\d\d)(.\d)?(.*)?")

def get_real_branch_name(version):
  if version.startswith("master"):
    return version

  match = branch_re.match(version)
  saas, major, minor, other = match.groups()

  if other:
    return version

  if not saas and minor and minor != ".0":
    return "saas-" + major + minor

  if not saas and not minor:
    return major + ".0"

  return version


def get_version_absolute_path(version):
  wtrelative = worktreepath.format(version=version).split("/")
  return str(home.joinpath(*wtrelative))

def get_main_repo_path(repo):
  return str(home.joinpath(*odooRepos[repo].split("/")))

def make_worktree(repo, base_branch, gitargs):
  repopath = get_main_repo_path(repo)
  gitparser = argparse.ArgumentParser()
  gitparser.add_argument("-n", "--branch-name")
  args = gitparser.parse_known_args(gitargs)

  wt_name = base_branch
  if args[0].branch_name:
    wt_name = args[0].branch_name

  wt_path = get_version_absolute_path(wt_name) + "/" + repo
  cmd = ["git", "-C", str(repopath), "worktree", "add"]
  cmd.extend(args[1])
  cmd.extend([str(wt_path), base_branch])
  subprocess.run(cmd)

def remove_worktree(repo, version):
  repopath = get_main_repo_path(repo)
  wt_path = get_version_absolute_path(version) + "/" + repo
  subprocess.run(["git", "-C", str(repopath), "worktree", "remove", str(wt_path)])

def remove_version_dir(version):
  wt_path = get_version_absolute_path(version)
  os.rmdir(str(wt_path))


NUMBER_TO_PORT = {
  0: 8069,
  1: 9069,
}

def _separate_remainings(args):
  try:
    index = args.index("--")
  except ValueError:
    return args, []
  return args[:index-1], args[index+1:]

def get_odoo_run_cmd(version, args):
  parser = argparse.ArgumentParser()
  parser.add_argument("-p", "--port", required=False)
  parser.add_argument("-s", "--shell", action="store_true", required=False)
  own, odoo_args = parser.parse_known_args(args)
  odoo_args = [a for a in odoo_args if a != "--"]

  odoo_cli = odoo_args
  if own.shell:
    odoo_cli.append("shell")
  odoo_cli.extend(["--addons-path=" + ",".join(["enterprise", "odoo/addons", "odoo/odoo/addons"])])

  if "-d" not in odoo_args:
    odoo_cli.extend(["-d", version])

  if own.port:
    odoo_cli.append("--xmlrpc-port=" + str(NUMBER_TO_PORT[int(own.port)]))

  cmd = [odoo_bin_path] + odoo_cli
  return cmd

if __name__ == "__main__":
  parser = argparse.ArgumentParser(description='Make worktree')
  parser.add_argument("operation")
  parser.add_argument("version", nargs="?", default="")
  own, additional = parser.parse_known_args()

  if own.operation == "list":
    dirs = os.scandir(str(home.joinpath(*worktrees_root.split("/"))))
    print("\n".join([d.name for d in dirs]))
    sys.exit(0)

  branch = get_real_branch_name(own.version)

  if own.operation == "add":
      for repo in odooRepos.keys():
        make_worktree(repo, branch, additional)
  if own.operation == "remove":
      for repo in odooRepos.keys():
        remove_worktree(repo, branch)
      remove_version_dir(branch)

  if own.operation == "run":
    odoo_cmd = get_odoo_run_cmd(branch, additional)
    print(" ".join(odoo_cmd))

  if own.operation == "path":
    print(get_version_absolute_path(branch))
